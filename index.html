<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kawaii Starter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'VT323', monospace;
        background-color: #fce7f3; /* Pink-100 */
        background-image: radial-gradient(#fbcfe8 15%, transparent 16%), radial-gradient(#fbcfe8 15%, transparent 16%);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #fdf2f8; 
      }
      ::-webkit-scrollbar-thumb {
        background: #f472b6; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #ec4899; 
      }
      
      /* Animations */
      @keyframes bounce-in {
        0% { transform: scale(0.9); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
      }
      .animate-bounce-in {
        animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .animate-spin-slow {
        animation: spin 3s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
      }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons (Inline SVGs to remove dependencies) ---
        const Icons = {
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Star: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Timer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>,
            Gift: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            MessageHeart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M12 7.5a2.5 2.5 0 0 0-3.59 3.5l3.59 3.6 3.59-3.6A2.5 2.5 0 0 0 12 7.5z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        };

        // --- Constants ---
        const TARGET_AMOUNT = 1000;
        const SESSION_DURATION = 5 * 60; // 5 minutes in seconds
        
        const PLEDGE_AMOUNT = 10; 
        const PENALTY_TOTAL = 20; 
        const RECORD_FAIL_AMOUNT = -10;
        const RECORD_SUCCESS_AMOUNT = 10;
        const SPINS_THRESHOLD = 5; 

        const RecordType = {
          SUCCESS: 'SUCCESS',
          FAILURE: 'FAILURE',
          LOTTERY: 'LOTTERY',
        };

        const LOTTERY_RULES = [
          { label: 'Minor Encouragement', amount: 10, probability: 0.4, color: 'text-blue-500' },
          { label: 'Medium Surprise', amount: 20, probability: 0.3, color: 'text-green-500' },
          { label: 'Big Explosion', amount: 40, probability: 0.2, color: 'text-purple-500' },
          { label: 'Super Jackpot', amount: 60, probability: 0.1, color: 'text-red-500' },
        ];

        // --- API Helper (Direct fetch for standalone HTML) ---
        const generateGeminiResponse = async (apiKey, history, newPrompt) => {
          const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
          
          // Construct chat history in Gemini format
          const contents = history.map(msg => ({
            role: msg.role === 'user' ? 'user' : 'model',
            parts: [{ text: msg.text }]
          }));
          
          // Add the new message
          contents.push({
            role: 'user',
            parts: [{ text: newPrompt }]
          });

          const systemInstruction = {
             parts: [{ text: "You are a super cute, supportive, and kawaii travel fund assistant. The user is trying to save money by doing 5-minute work sprints. When the user complains or whines (sajiao), be very sympathetic, use emojis (like ‚ú®, üíñ, (¬¥ÔΩ°‚Ä¢ ·µï ‚Ä¢ÔΩ°`)), but gently encourage them to just do 5 minutes. Remind them of the travel goal. Keep responses short (under 50 words) and sweet. Act like a close friend." }]
          };

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: contents,
              systemInstruction: systemInstruction
            })
          });

          if (!response.ok) {
            throw new Error('API Request Failed');
          }

          const data = await response.json();
          return data.candidates[0].content.parts[0].text;
        };

        // --- Components ---

        const PixelCard = ({ children, className = "", title, icon }) => (
          <div className={`bg-white border-4 border-gray-900 shadow-[6px_6px_0px_0px_rgba(0,0,0,0.2)] rounded-xl p-4 ${className}`}>
            {(title || icon) && (
              <div className="flex items-center gap-2 mb-3 border-b-2 border-gray-100 pb-2">
                {icon && <span className="text-pink-500">{icon}</span>}
                {title && <h2 className="text-xl font-bold text-gray-800">{title}</h2>}
              </div>
            )}
            {children}
          </div>
        );

        const PixelButton = ({ children, variant = 'primary', className = "", ...props }) => {
          const baseStyle = "border-2 border-gray-900 font-bold px-4 py-2 rounded-lg active:translate-y-1 active:shadow-none transition-all uppercase tracking-wider font-['VT323'] text-xl";
          
          const variants = {
            primary: "bg-pink-300 hover:bg-pink-400 text-gray-900 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]",
            danger: "bg-red-300 hover:bg-red-400 text-gray-900 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]",
            success: "bg-green-300 hover:bg-green-400 text-gray-900 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]",
            warning: "bg-yellow-200 hover:bg-yellow-300 text-gray-900 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]",
          };

          return (
            <button className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
              {children}
            </button>
          );
        };

        const ChatBubble = ({ role, text }) => (
            <div className={`flex w-full mb-2 ${role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[80%] p-2 rounded-lg border-2 border-gray-900 text-lg leading-tight 
                    ${role === 'user' 
                        ? 'bg-pink-100 text-gray-800 rounded-br-none shadow-[2px_2px_0px_0px_rgba(236,72,153,0.3)]' 
                        : 'bg-white text-gray-700 rounded-bl-none shadow-[2px_2px_0px_0px_rgba(0,0,0,0.1)]'
                    }`}
                >
                   {role === 'model' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(text) }} /> : text}
                </div>
            </div>
        );

        // --- Main App ---

        function App() {
          // --- State ---
          const [fund, setFund] = useState(0);
          const [records, setRecords] = useState([]);
          const [successCount, setSuccessCount] = useState(0);
          const [spinsAvailable, setSpinsAvailable] = useState(0);
          const [sessionStartTime, setSessionStartTime] = useState(null);
          const [apiKey, setApiKey] = useState('');

          // Timer State
          const [isTimerRunning, setIsTimerRunning] = useState(false);
          const [timeLeft, setTimeLeft] = useState(SESSION_DURATION);
          const timerRef = useRef(null);

          // Modals & Chat
          const [activeModal, setActiveModal] = useState(null);
          const [selectedRecordId, setSelectedRecordId] = useState(null);
          const [lotteryResult, setLotteryResult] = useState(null);
          const [isChatOpen, setIsChatOpen] = useState(false);
          const [chatMessages, setChatMessages] = useState([{role: 'model', text: "Hii! I'm here if you feel tired! (¬¥ÔΩ°‚Ä¢ ·µï ‚Ä¢ÔΩ°`) ‚ô°"}]);
          const [chatInput, setChatInput] = useState("");
          const [isTalking, setIsTalking] = useState(false);
          const chatEndRef = useRef(null);

          // --- Logic Functions ---

          const addStandardRecord = (type, amount, description) => {
            const newRecord = {
              id: Date.now().toString(),
              type,
              amount,
              timestamp: Date.now(),
              description,
            };
            setRecords(prev => [newRecord, ...prev]);
            setFund(prev => prev + amount);
          };

          const finishTimer = useCallback(() => {
            setIsTimerRunning(false);
            setSessionStartTime(null);
            setTimeLeft(SESSION_DURATION);
            
            // SUCCESS LOGIC
            setRecords(prev => [{
              id: Date.now().toString(),
              type: RecordType.SUCCESS,
              amount: RECORD_SUCCESS_AMOUNT,
              timestamp: Date.now(),
              description: 'Focus Success',
            }, ...prev]);
            
            setSuccessCount(prev => {
              const newCount = prev + 1;
              if (newCount % SPINS_THRESHOLD === 0) {
                setSpinsAvailable(s => s + 1);
              }
              return newCount;
            });
          }, []);

          // --- Persistence ---
          
          useEffect(() => {
            const storedData = localStorage.getItem('kawaii-starter-data');
            if (storedData) {
              try {
                const parsed = JSON.parse(storedData);
                setFund(parsed.fund ?? 0);
                setRecords(parsed.records ?? []);
                setSuccessCount(parsed.successCount ?? 0);
                setSpinsAvailable(parsed.spinsAvailable ?? 0);
                setApiKey(parsed.apiKey ?? '');
                
                if (parsed.sessionStartTime) {
                  const now = Date.now();
                  const elapsedSeconds = Math.floor((now - parsed.sessionStartTime) / 1000);
                  const remaining = SESSION_DURATION - elapsedSeconds;

                  if (remaining > 0) {
                    setSessionStartTime(parsed.sessionStartTime);
                    setTimeLeft(remaining);
                    setIsTimerRunning(true);
                  } else {
                    setSessionStartTime(null);
                  }
                }
              } catch (e) {
                console.error("Failed to load data", e);
              }
            }
          }, []);

          useEffect(() => {
            const data = { 
              fund, 
              target: TARGET_AMOUNT, 
              successCount, 
              spinsAvailable, 
              records,
              sessionStartTime,
              apiKey // Persist API Key
            };
            localStorage.setItem('kawaii-starter-data', JSON.stringify(data));
          }, [fund, successCount, spinsAvailable, records, sessionStartTime, apiKey]);

          // Scroll to bottom of chat
          useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [chatMessages, isChatOpen]);

          // --- Actions ---

          const deleteRecord = () => {
            if (!selectedRecordId) return;
            const record = records.find(r => r.id === selectedRecordId);
            if (record) {
              setFund(prev => prev - record.amount);
              setRecords(prev => prev.filter(r => r.id !== selectedRecordId));
            }
            setActiveModal(null);
            setSelectedRecordId(null);
          };

          const startTimer = () => {
            setActiveModal(null);
            setIsTimerRunning(true);
            const now = Date.now();
            setSessionStartTime(now);
            setTimeLeft(SESSION_DURATION);
            setFund(prev => prev + PLEDGE_AMOUNT);
          };

          const stopTimer = () => {
            setActiveModal(null);
            setIsTimerRunning(false);
            setSessionStartTime(null);
            setTimeLeft(SESSION_DURATION);
            setFund(prev => prev - PENALTY_TOTAL); 
            setRecords(prev => [{
              id: Date.now().toString(),
              type: RecordType.FAILURE,
              amount: RECORD_FAIL_AMOUNT,
              timestamp: Date.now(),
              description: 'Given Up',
            }, ...prev]);
          };

          // Timer Interval
          useEffect(() => {
            if (isTimerRunning) {
              timerRef.current = window.setInterval(() => {
                setTimeLeft(prev => {
                  if (prev <= 1) {
                    if (timerRef.current) clearInterval(timerRef.current);
                    finishTimer();
                    return 0;
                  }
                  return prev - 1;
                });
              }, 1000);
            } else {
              if (timerRef.current) clearInterval(timerRef.current);
            }
            return () => {
              if (timerRef.current) clearInterval(timerRef.current);
            };
          }, [isTimerRunning, finishTimer]);

          const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
          };

          const playLottery = () => {
            if (spinsAvailable <= 0) return;
            setActiveModal(null);
            setSpinsAvailable(prev => prev - 1);

            const rand = Math.random();
            let cumulative = 0;
            let selectedRule = LOTTERY_RULES[0];

            for (const rule of LOTTERY_RULES) {
              cumulative += rule.probability;
              if (rand <= cumulative) {
                selectedRule = rule;
                break;
              }
            }

            setLotteryResult({ amount: selectedRule.amount, label: selectedRule.label });
            addStandardRecord(RecordType.LOTTERY, selectedRule.amount, `Lottery: ${selectedRule.label}`);
            setActiveModal('lotteryResult');
          };
          
          const exportData = () => {
            const dataStr = localStorage.getItem('kawaii-starter-data');
            if (!dataStr) return;
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `travel-fund-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setActiveModal(null);
          };

          const handleChatSend = async (e) => {
             e.preventDefault();
             if(!chatInput.trim() || isTalking) return;
             
             if (!apiKey) {
                 setChatMessages(prev => [...prev, {role: 'model', text: "Wait! I need your Gemini API Key first. Click the Gear icon (‚öôÔ∏è) to set it up! (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)"}]);
                 setChatInput("");
                 return;
             }

             const userMsg = chatInput;
             setChatInput("");
             setChatMessages(prev => [...prev, {role: 'user', text: userMsg}]);
             setIsTalking(true);

             try {
                 // Pass context: recent history
                 const responseText = await generateGeminiResponse(apiKey, chatMessages.slice(-5), userMsg);
                 setChatMessages(prev => [...prev, {role: 'model', text: responseText}]);
             } catch (error) {
                 setChatMessages(prev => [...prev, {role: 'model', text: "Oops, my brain disconnected... Check your API key? (xx)"}]);
             } finally {
                 setIsTalking(false);
             }
          };

          const distanceToTarget = TARGET_AMOUNT - fund;
          const distanceText = `Ôø•${distanceToTarget.toFixed(2)}`;

          return (
            <div className="min-h-screen p-4 md:p-8 max-w-lg mx-auto flex flex-col gap-6 text-lg relative pb-32 font-['VT323']">
              
              {/* Header Buttons */}
              <div className="absolute top-4 right-4 z-20 flex gap-2">
                 <button 
                  onClick={() => setActiveModal('settings')}
                  className="bg-white border-2 border-gray-900 p-2 rounded-lg shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:bg-gray-100 active:translate-y-1 active:shadow-none transition-all"
                  title="Settings"
                >
                  <Icons.Settings />
                </button>
                <button 
                  onClick={() => setActiveModal('data')}
                  className="bg-white border-2 border-gray-900 p-2 rounded-lg shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] hover:bg-gray-100 active:translate-y-1 active:shadow-none transition-all"
                  title="Save/Backup"
                >
                  <Icons.Save />
                </button>
              </div>

              {/* Fund Card */}
              <PixelCard className="text-center bg-pink-50 relative overflow-hidden mt-12 md:mt-0">
                <div className="absolute -top-4 -right-4 text-9xl opacity-10 rotate-12">‚úàÔ∏è</div>
                <h1 className="text-2xl text-gray-600 mb-1 font-bold">Travel Fund üéÄ</h1>
                
                <div className={`text-6xl font-bold mb-4 ${fund < 0 ? 'text-red-500' : 'text-pink-600'} drop-shadow-md`}>
                  {fund} <span className="text-3xl text-gray-500">RMB</span>
                </div>

                <div className="relative w-full h-12 bg-gray-200 rounded-full border-4 border-gray-800 overflow-hidden mb-2">
                  <div 
                    className={`h-full transition-all duration-500 flex items-center justify-end px-2 ${fund < 0 ? 'bg-red-400' : 'bg-gradient-to-r from-pink-300 to-purple-400'}`}
                    style={{ width: `${Math.max(0, Math.min(100, (fund / TARGET_AMOUNT) * 100))}%` }}
                  >
                    {fund > 0 && <span className="text-white text-xl animate-pulse">‚ú®</span>}
                  </div>
                  <div className="absolute inset-0 flex items-center justify-center text-lg font-bold text-gray-800 mix-blend-multiply z-10 whitespace-nowrap px-2 uppercase">
                     Target: Ôø•{TARGET_AMOUNT} | Remaining: {distanceText}
                  </div>
                </div>
              </PixelCard>

              {/* Timer Card */}
              <PixelCard className="text-center py-8 relative">
                <div className="text-[9rem] leading-none text-gray-800 mb-8 drop-shadow-[4px_4px_0px_rgba(244,114,182,0.4)]">
                  {formatTime(timeLeft)}
                </div>

                {!isTimerRunning ? (
                  <PixelButton 
                    className="text-2xl px-12 py-6 w-full md:w-auto animate-bounce" 
                    onClick={() => setActiveModal('start')}
                  >
                    Start 5 Min üöÄ
                  </PixelButton>
                ) : (
                  <div className="flex flex-col items-center gap-4">
                    <p className="text-pink-600 animate-pulse font-bold text-2xl">‚ú® Focus Mode On ‚ú®</p>
                    <PixelButton 
                      variant="danger" 
                      onClick={() => setActiveModal('stop')}
                    >
                      Give Up... ü•≤
                    </PixelButton>
                  </div>
                )}
              </PixelCard>

              {/* Lottery Card */}
              <PixelCard className="bg-gradient-to-br from-yellow-50 to-orange-50 border-orange-200">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-2xl font-bold text-orange-600 flex items-center gap-2">
                      <Icons.Gift /> Gacha Station
                    </h3>
                    <p className="text-lg text-gray-600">Every 5 successes = 1 Spin!</p>
                  </div>
                  <button onClick={() => setActiveModal('lotteryRules')} className="text-orange-400 hover:text-orange-600">
                    <Icons.Info />
                  </button>
                </div>

                <div className="flex items-center justify-between bg-white/50 p-3 rounded-lg border-2 border-orange-100">
                  <div className="flex items-center gap-2">
                    <Icons.Star className={`w-6 h-6 ${spinsAvailable > 0 ? 'fill-yellow-400 text-yellow-500' : 'text-gray-300'}`} />
                    <span className="font-bold text-gray-700 text-xl">Spins: {spinsAvailable}</span>
                  </div>
                  <PixelButton 
                    variant="warning" 
                    disabled={spinsAvailable === 0}
                    className={spinsAvailable === 0 ? 'opacity-50 cursor-not-allowed shadow-none' : ''}
                    onClick={() => setActiveModal('lottery')}
                  >
                    SPIN! üé∞
                  </PixelButton>
                </div>
                
                <div className="mt-3 flex gap-2 justify-center">
                  {[...Array(5)].map((_, i) => (
                     <div 
                       key={i} 
                       className={`w-4 h-4 rounded-sm border-2 border-gray-400 ${i < (successCount % 5) ? 'bg-green-400 border-gray-900' : 'bg-gray-200'}`} 
                     />
                  ))}
                </div>
              </PixelCard>

              {/* History */}
              <div className="flex-1">
                <h3 className="text-2xl font-bold text-gray-700 mb-4 flex items-center gap-2 border-b-2 border-pink-200 pb-2">
                  <Icons.Timer /> History Log
                </h3>
                
                <div className="space-y-3">
                  {records.length === 0 ? (
                    <div className="text-center text-gray-400 py-8 italic border-4 border-dashed border-gray-300 rounded-lg text-xl">
                      No records yet. Let's start!
                    </div>
                  ) : (
                    records.map((record) => (
                      <div 
                        key={record.id} 
                        className="bg-white border-b-4 border-r-4 border-gray-200 p-4 rounded-lg flex justify-between items-center group hover:border-pink-300 transition-colors"
                      >
                        <div>
                          <div className="text-sm text-gray-400">
                            {new Date(record.timestamp).toLocaleString()}
                          </div>
                          <div className="font-bold text-gray-700 text-xl">{record.description}</div>
                        </div>
                        <div className="flex items-center gap-4">
                          {record.amount !== 0 && (
                            <span className={`font-bold text-2xl ${record.amount > 0 ? 'text-green-500' : 'text-red-500'}`}>
                              {record.amount > 0 ? '+' : ''}{record.amount}
                            </span>
                          )}
                          {record.amount === 0 && (
                            <span className="font-bold text-gray-400 text-sm">--</span>
                          )}
                          <button 
                            onClick={() => { setSelectedRecordId(record.id); setActiveModal('delete'); }}
                            className="text-gray-300 hover:text-red-400 transition-colors"
                          >
                            <Icons.Trash2 />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* --- CHAT BOT FLOATING BUTTON & WINDOW --- */}
              <div className="fixed bottom-6 right-6 z-40 flex flex-col items-end">
                {isChatOpen && (
                   <div className="mb-4 w-80 bg-white border-4 border-gray-900 rounded-xl shadow-[8px_8px_0px_0px_rgba(0,0,0,0.2)] animate-bounce-in flex flex-col overflow-hidden max-h-[500px]">
                      <div className="bg-pink-300 p-3 border-b-4 border-gray-900 flex justify-between items-center">
                         <div className="font-bold text-gray-900 flex items-center gap-2">
                             <span className="text-2xl">üíñ</span> Comfort Corner
                         </div>
                         <button onClick={() => setIsChatOpen(false)} className="hover:bg-pink-400 rounded p-1"><Icons.X /></button>
                      </div>
                      <div className="flex-1 overflow-y-auto p-4 bg-pink-50 min-h-[300px] flex flex-col">
                          {chatMessages.map((msg, i) => (
                              <ChatBubble key={i} role={msg.role} text={msg.text} />
                          ))}
                          {isTalking && (
                              <div className="flex justify-start w-full mb-2">
                                <div className="bg-white p-3 rounded-lg border-2 border-gray-900 rounded-bl-none flex gap-1 items-center">
                                   <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                   <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                   <div className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                                </div>
                              </div>
                          )}
                          <div ref={chatEndRef}></div>
                      </div>
                      <form onSubmit={handleChatSend} className="p-2 border-t-4 border-gray-900 bg-white flex gap-2">
                          <input 
                            type="text" 
                            className="flex-1 border-2 border-gray-300 rounded-lg px-3 py-2 font-['VT323'] text-xl focus:outline-none focus:border-pink-500"
                            placeholder="Complain here..."
                            value={chatInput}
                            onChange={(e) => setChatInput(e.target.value)}
                          />
                          <button type="submit" disabled={isTalking} className="bg-pink-400 text-white p-2 rounded-lg border-2 border-gray-900 hover:bg-pink-500 disabled:opacity-50">
                             <Icons.Send />
                          </button>
                      </form>
                   </div>
                )}
                <button 
                  onClick={() => setIsChatOpen(!isChatOpen)}
                  className="bg-pink-400 hover:bg-pink-500 text-white border-4 border-gray-900 w-16 h-16 rounded-full flex items-center justify-center shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-1 active:shadow-none transition-all"
                >
                  <Icons.MessageHeart />
                </button>
              </div>

              {/* Modals */}
              {activeModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className="bg-white border-4 border-gray-900 shadow-[8px_8px_0px_0px_rgba(255,255,255,0.5)] rounded-2xl p-6 w-full max-w-sm animate-bounce-in font-['VT323']">
                    
                    {activeModal === 'start' && (
                      <div className="text-center">
                        <div className="text-6xl mb-4">üò§</div>
                        <h3 className="text-3xl font-bold mb-2">Ready?</h3>
                        <p className="text-gray-600 mb-6 text-xl">
                          We invest <strong>{PLEDGE_AMOUNT} RMB</strong> now.<br/>
                          Finish to keep it. Quit to lose it!
                        </p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton variant="primary" onClick={() => setActiveModal(null)} className="bg-gray-200 border-gray-400 shadow-none">Cancel</PixelButton>
                          <PixelButton variant="success" onClick={startTimer}>I'm Ready!</PixelButton>
                        </div>
                      </div>
                    )}

                    {activeModal === 'stop' && (
                      <div className="text-center">
                        <div className="text-6xl mb-4">üò±</div>
                        <h3 className="text-3xl font-bold mb-2 text-red-500">Wait!!</h3>
                        <p className="text-gray-600 mb-6 text-xl">
                          You will lose your pledge and pay a penalty.<br/>
                          <strong className="text-red-500 block mt-2">Net Loss: {RECORD_FAIL_AMOUNT} RMB</strong>
                        </p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton variant="success" onClick={() => setActiveModal(null)}>Continue</PixelButton>
                          <PixelButton variant="danger" onClick={stopTimer}>Give Up</PixelButton>
                        </div>
                      </div>
                    )}

                    {activeModal === 'delete' && (
                      <div className="text-center">
                        <div className="text-6xl mb-4">üóëÔ∏è</div>
                        <h3 className="text-3xl font-bold mb-2">Delete Record?</h3>
                        <p className="text-gray-600 mb-6 text-xl">This will reverse the money change.</p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton onClick={() => { setActiveModal(null); setSelectedRecordId(null); }} className="bg-gray-200 border-gray-400 shadow-none">Cancel</PixelButton>
                          <PixelButton variant="danger" onClick={deleteRecord}>Delete</PixelButton>
                        </div>
                      </div>
                    )}

                    {activeModal === 'lotteryRules' && (
                      <div>
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-bold">üé∞ Gacha Rates</h3>
                          <button onClick={() => setActiveModal(null)}><Icons.X /></button>
                        </div>
                        <div className="space-y-3">
                          {LOTTERY_RULES.map((rule, idx) => (
                            <div key={idx} className="flex justify-between items-center border-b border-gray-100 pb-2 text-xl">
                              <div>
                                <div className={`font-bold ${rule.color}`}>{rule.label}</div>
                                <div className="text-sm text-gray-500">Reward: {rule.amount} RMB</div>
                              </div>
                              <div className="font-mono bg-gray-100 px-2 py-1 rounded">{(rule.probability * 100).toFixed(0)}%</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeModal === 'lottery' && (
                      <div className="text-center">
                        <div className="text-6xl mb-4 animate-spin-slow">üé°</div>
                        <h3 className="text-3xl font-bold mb-2">Use 1 Spin?</h3>
                        <p className="text-gray-600 mb-6 text-xl">Good luck!</p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton onClick={() => setActiveModal(null)} className="bg-gray-200 border-gray-400 shadow-none">Cancel</PixelButton>
                          <PixelButton variant="warning" onClick={playLottery}>SPIN!</PixelButton>
                        </div>
                      </div>
                    )}

                    {activeModal === 'lotteryResult' && lotteryResult && (
                      <div className="text-center">
                        <div className="text-6xl mb-4 animate-bounce">üéâ</div>
                        <h3 className="text-2xl text-gray-500 mb-1">You won...</h3>
                        <div className="text-4xl font-bold text-pink-500 mb-2">{lotteryResult.label}!</div>
                        <div className="text-6xl font-bold text-green-500 mb-6">+{lotteryResult.amount} RMB</div>
                        <PixelButton variant="primary" onClick={() => setActiveModal(null)}>Awesome!</PixelButton>
                      </div>
                    )}

                    {activeModal === 'data' && (
                      <div className="text-center">
                        <div className="text-6xl mb-4">üíæ</div>
                        <h3 className="text-3xl font-bold mb-2">Data Backup</h3>
                        <p className="text-gray-600 mb-6 text-xl">
                          Download your progress as a file to keep it safe.
                        </p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton onClick={() => setActiveModal(null)} className="bg-gray-200 border-gray-400 shadow-none">Close</PixelButton>
                          <PixelButton variant="primary" onClick={exportData} className="flex items-center gap-2">
                            <Icons.Download /> Export
                          </PixelButton>
                        </div>
                      </div>
                    )}
                    
                    {activeModal === 'settings' && (
                      <div className="">
                        <div className="flex justify-between items-center mb-4">
                           <h3 className="text-3xl font-bold">‚öôÔ∏è Settings</h3>
                           <button onClick={() => setActiveModal(null)}><Icons.X /></button>
                        </div>
                        <p className="text-gray-600 mb-2 text-xl">Gemini API Key:</p>
                        <input 
                           type="text" 
                           value={apiKey} 
                           onChange={(e) => setApiKey(e.target.value)} 
                           placeholder="Paste your key here..."
                           className="w-full border-2 border-gray-300 rounded px-2 py-2 mb-4 font-mono text-sm"
                        />
                        <p className="text-xs text-gray-500 mb-6">
                           Key is stored in your browser's LocalStorage. Get one at <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-pink-500 underline">Google AI Studio</a>.
                        </p>
                        <div className="flex gap-4 justify-center">
                          <PixelButton variant="success" onClick={() => setActiveModal(null)}>Save</PixelButton>
                        </div>
                      </div>
                    )}

                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>